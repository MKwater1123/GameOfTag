<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Tag - ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
        }

        .status {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }

        .label {
            font-weight: bold;
            color: #666;
        }

        .value {
            color: #333;
        }

        .success {
            color: #4caf50;
        }

        .error {
            color: #f44336;
        }

        .warning {
            color: #ff9800;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        #log {
            background: #222;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <h1>ğŸ§ª GPS Tag - ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</h1>

    <div class="card">
        <h2>ã‚·ã‚¹ãƒ†ãƒ ãƒã‚§ãƒƒã‚¯</h2>
        <div class="status">
            <span class="label">Geolocation API:</span>
            <span class="value" id="geo-status">ç¢ºèªä¸­...</span>
        </div>
        <div class="status">
            <span class="label">Firebase:</span>
            <span class="value" id="firebase-status">ç¢ºèªä¸­...</span>
        </div>
        <div class="status">
            <span class="label">Leaflet:</span>
            <span class="value" id="leaflet-status">ç¢ºèªä¸­...</span>
        </div>
    </div>

    <div class="card">
        <h2>ç¾åœ¨ä½ç½®</h2>
        <div class="status">
            <span class="label">ç·¯åº¦:</span>
            <span class="value" id="lat">--</span>
        </div>
        <div class="status">
            <span class="label">çµŒåº¦:</span>
            <span class="value" id="lng">--</span>
        </div>
        <div class="status">
            <span class="label">ç²¾åº¦:</span>
            <span class="value" id="accuracy">--</span>
        </div>
        <button class="btn-primary" onclick="getLocation()">ä½ç½®æƒ…å ±ã‚’å–å¾—</button>
    </div>

    <div class="card">
        <h2>Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ</h2>
        <button class="btn-success" onclick="testFirebaseWrite()">ãƒ‡ãƒ¼ã‚¿æ›¸ãè¾¼ã¿</button>
        <button class="btn-primary" onclick="testFirebaseRead()">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</button>
        <button class="btn-danger" onclick="clearTestData()">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
    </div>

    <div class="card">
        <h2>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2>
        <button class="btn-primary" onclick="window.location.href='index.html'">æœ¬ã‚¢ãƒ—ãƒªã‚’èµ·å‹•</button>
    </div>

    <div class="card">
        <h2>ãƒ­ã‚°</h2>
        <div id="log"></div>
    </div>

    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script type="module">
        import { firebaseConfig } from './js/firebase-config.js';

        let database;
        const logElement = document.getElementById('log');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f44' : type === 'success' ? '#4f4' : '#0f0';
            logElement.innerHTML += `<div style="color:${color}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        // ã‚·ã‚¹ãƒ†ãƒ ãƒã‚§ãƒƒã‚¯
        function checkSystems() {
            // Geolocation
            if ('geolocation' in navigator) {
                document.getElementById('geo-status').innerHTML = '<span class="success">âœ“ åˆ©ç”¨å¯èƒ½</span>';
                log('Geolocation API: OK', 'success');
            } else {
                document.getElementById('geo-status').innerHTML = '<span class="error">âœ— åˆ©ç”¨ä¸å¯</span>';
                log('Geolocation API: NG', 'error');
            }

            // Leaflet
            if (typeof L !== 'undefined') {
                document.getElementById('leaflet-status').innerHTML = '<span class="success">âœ“ èª­ã¿è¾¼ã¿æ¸ˆã¿</span>';
                log('Leaflet: OK', 'success');
            } else {
                document.getElementById('leaflet-status').innerHTML = '<span class="error">âœ— æœªèª­ã¿è¾¼ã¿</span>';
                log('Leaflet: NG', 'error');
            }

            // Firebase
            if (typeof firebase !== 'undefined') {
                try {
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    document.getElementById('firebase-status').innerHTML = '<span class="success">âœ“ æ¥ç¶šæ¸ˆã¿</span>';
                    log('Firebase: åˆæœŸåŒ–æˆåŠŸ', 'success');
                } catch (error) {
                    document.getElementById('firebase-status').innerHTML = '<span class="error">âœ— åˆæœŸåŒ–å¤±æ•—</span>';
                    log('Firebase: ' + error.message, 'error');
                }
            } else {
                document.getElementById('firebase-status').innerHTML = '<span class="error">âœ— æœªèª­ã¿è¾¼ã¿</span>';
                log('Firebase: CDNæœªèª­ã¿è¾¼ã¿', 'error');
            }
        }

        // ä½ç½®æƒ…å ±å–å¾—
        window.getLocation = function () {
            log('ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...');
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    document.getElementById('lat').textContent = position.coords.latitude.toFixed(6);
                    document.getElementById('lng').textContent = position.coords.longitude.toFixed(6);
                    document.getElementById('accuracy').textContent = position.coords.accuracy.toFixed(2) + ' m';
                    log(`ä½ç½®å–å¾—æˆåŠŸ: ${position.coords.latitude}, ${position.coords.longitude}`, 'success');
                },
                (error) => {
                    log('ä½ç½®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                    alert('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            );
        };

        // Firebaseæ›¸ãè¾¼ã¿ãƒ†ã‚¹ãƒˆ
        window.testFirebaseWrite = function () {
            if (!database) {
                log('FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            const testData = {
                username: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
                role: 'runner',
                lat: 35.6895,
                lng: 139.6917,
                updated_at: Date.now()
            };

            log('Firebaseã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿ä¸­...');
            database.ref('game_session_v1/players/test_user').set(testData)
                .then(() => {
                    log('ãƒ‡ãƒ¼ã‚¿æ›¸ãè¾¼ã¿æˆåŠŸï¼', 'success');
                })
                .catch((error) => {
                    log('æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                });
        };

        // Firebaseèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
        window.testFirebaseRead = function () {
            if (!database) {
                log('FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            log('Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
            database.ref('game_session_v1/players').once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ: ' + JSON.stringify(data, null, 2), 'success');
                    } else {
                        log('ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“', 'info');
                    }
                })
                .catch((error) => {
                    log('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                });
        };

        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        window.clearTestData = function () {
            if (!database) {
                log('FirebaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            if (confirm('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                log('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ä¸­...');
                database.ref('game_session_v1/players/test_user').remove()
                    .then(() => {
                        log('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤æˆåŠŸ', 'success');
                    })
                    .catch((error) => {
                        log('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                    });
            }
        };

        // åˆæœŸåŒ–
        checkSystems();
    </script>
</body>

</html>